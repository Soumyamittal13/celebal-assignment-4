SELECT W.CODE, W.AGE, W.COST, WP.POWER
FROM WANDS W
JOIN WANDS_PROPERTY WP ON W.CODE = WP.CODE AND W.AGE = WP.AGE
WHERE W.IS_EVIL = 0
  AND W.COST = (
      SELECT MAX(W2.COST)
      FROM WANDS W2
      JOIN WANDS_PROPERTY WP2 ON W2.CODE = WP2.CODE AND W2.AGE = WP2.AGE
      WHERE W2.IS_EVIL = 0
        AND WP2.POWER = WP.POWER
        AND WP2.AGE = WP.AGE
  )
ORDER BY WP.POWER DESC, W.AGE DESC;
